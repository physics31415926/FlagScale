name: Common Functional Tests

# NOTE: This workflow is a TEMPLATE/REFERENCE for functional test workflows
# Task-specific workflows (functional_tests_train.yml, etc.) are preferred for production use
# This template demonstrates the standard pattern for running functional tests with install script

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
        description: Platform name (e.g., cuda, default)
      device:
        required: true
        type: string
        description: Device type (e.g., a100, a800, h100, generic)
      task:
        required: true
        type: string
        description: Task name (e.g., train, hetero_train, inference, rl)
      model:
        required: true
        type: string
        description: Model name (e.g., aquila, mixtral, deepseek)
      case:
        required: false
        type: string
        description: Specific test case (e.g., tp2_pp2, tp4_pp2)
      conda_env:
        required: false
        type: string
        description: Conda environment name (optional, skips conda if not provided)
        default: ""
      conda_path:
        required: false
        type: string
        description: Conda installation path (optional, auto-detects if not provided)
        default: "/root/miniconda3"
      image:
        required: true
        type: string
      runs_on:
        required: true
        type: string
      container_volumes:
        required: true
        type: string
      container_options:
        required: true
        type: string
      source_artifact:
        required: true
        type: string
        description: Name of the artifact containing source code

jobs:
  functional_test:
    defaults:
      run:
        shell: bash
    env:
      PROJECT_ROOT: /workspace/FlagScale
    runs-on: ${{ fromJson(inputs.runs_on) }}
    container:
      image: ${{ inputs.image }}
      ports:
        - 80
      volumes: ${{ fromJson(inputs.container_volumes) }}
      options: ${{ inputs.container_options }}

    steps:
      - name: Download source code artifact (attempt 1)
        uses: actions/download-artifact@v4
        continue-on-error: true
        id: download_attempt_1
        with:
          name: ${{ inputs.source_artifact }}
          path: /tmp

      - name: Download source code artifact (attempt 2)
        if: steps.download_attempt_1.outcome == 'failure'
        uses: actions/download-artifact@v4
        continue-on-error: true
        id: download_attempt_2
        with:
          name: ${{ inputs.source_artifact }}
          path: /tmp

      - name: Download source code artifact (attempt 3)
        if: steps.download_attempt_2.outcome == 'failure'
        uses: actions/download-artifact@v4
        id: download_attempt_3
        with:
          name: ${{ inputs.source_artifact }}
          path: /tmp

      - name: Verify artifact download
        run: |
          if [ "${{ steps.download_attempt_1.outcome }}" == "success" ]; then
            echo "✅ Artifact downloaded successfully on attempt 1"
          elif [ "${{ steps.download_attempt_2.outcome }}" == "success" ]; then
            echo "✅ Artifact downloaded successfully on attempt 2 (retried once)"
          elif [ "${{ steps.download_attempt_3.outcome }}" == "success" ]; then
            echo "✅ Artifact downloaded successfully on attempt 3 (retried twice)"
          else
            echo "❌ Error: All 3 download attempts failed"
            echo "Artifact name: ${{ inputs.source_artifact }}"
            exit 1
          fi

      - name: Extract source code
        run: |
          mkdir -p $PROJECT_ROOT
          tar -xzf /tmp/flagscale-source.tar.gz -C $PROJECT_ROOT

      - name: Set safe directory
        run: |
          git config --global --add safe.directory $PROJECT_ROOT

      - name: Install dependencies for task
        run: |
          set -euo pipefail
          cd $PROJECT_ROOT

          PLATFORM='${{ inputs.platform }}'
          TASK='${{ inputs.task }}'
          CONDA_ENV='${{ inputs.conda_env }}'
          CONDA_PATH='${{ inputs.conda_path }}'

          echo "Installing dependencies for task: $TASK"
          echo "Platform: $PLATFORM"

          # Build install command with optional conda parameters
          INSTALL_CMD="./tools/install/install.sh --platform $PLATFORM --task $TASK --retry-count 3"
          if [ -n "$CONDA_ENV" ]; then
            INSTALL_CMD="$INSTALL_CMD --conda-env $CONDA_ENV"
            if [ -n "$CONDA_PATH" ]; then
              INSTALL_CMD="$INSTALL_CMD --conda-path $CONDA_PATH"
            fi
          fi

          # Run install script (handles conda activation internally if needed)
          eval $INSTALL_CMD
        timeout-minutes: 30

      - name: Run functional tests
        id: functional_test
        run: |
          set -euo pipefail
          cd $PROJECT_ROOT

          PLATFORM='${{ inputs.platform }}'
          DEVICE='${{ inputs.device }}'
          TASK='${{ inputs.task }}'
          MODEL='${{ inputs.model }}'
          CASE='${{ inputs.case }}'
          CONDA_ENV='${{ inputs.conda_env }}'
          CONDA_PATH='${{ inputs.conda_path }}'

          echo "Running functional tests for $TASK"
          echo "Platform: $PLATFORM"
          echo "Device: $DEVICE"
          echo "Task: $TASK"
          echo "Model: $MODEL"
          echo "Case: ${CASE:-all}"
          echo "Project root: $PROJECT_ROOT"

          # Source conda utilities for reusable functions
          source ./tools/install/utils/conda_utils.sh

          # Conditionally activate conda environment if specified
          if [ -n "$CONDA_ENV" ]; then
            if activate_conda "$CONDA_ENV" "$CONDA_PATH"; then
              : # Success message already displayed by activate_conda
            else
              echo "⚠️  Conda environment requested but conda not found"
              echo "Continuing without conda activation..."
            fi
          else
            echo "ℹ️  Running tests with system Python"
          fi

          # Display Python environment info
          echo "Python location: $(which python)"
          echo "Python version: $(python --version)"

          # Run functional tests using run_tests.sh
          bash "$PROJECT_ROOT/tests/test_utils/runners/run_tests.sh" \
            --platform "$PLATFORM" \
            --device "$DEVICE" \
            --type functional \
            --task "$TASK" \
            --model "$MODEL" \
            --list "$CASE"
          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "✅ Functional tests passed for $PLATFORM/$DEVICE/$TASK/$MODEL/$CASE"
          else
            echo "❌ Functional tests failed for $PLATFORM/$DEVICE/$TASK/$MODEL/$CASE (exit code: $exit_code)"
          fi

          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        timeout-minutes: 180
